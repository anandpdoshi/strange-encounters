{% extends "base/index.html" %}

{% block content %}
<!-- route outlet -->
<!-- component matched by the route will render here -->
<router-view v-on:login="setAuthenticated"></router-view>
{% endblock %}

{% block script %}
<script type="text/x-template" id="login-template">
    {% include "components/login.html" %}
</script>

<script type="text/babel">
    // 0. If using a module system (e.g. via vue-cli), import Vue and VueRouter
    // and then call `Vue.use(VueRouter)`.
    Vue.use(VueRouter);

    // 1. Define route components.
    // These can be imported from other files
    const Login = {
        template: '#login-template',
        data: function() {
            return {
                email: '',
                password: '',
                firstName: '',
                lastName: '',
                wantsToRegister: false,
                redirectTo: '',
            }
        },
        methods: {
            toggleRegister: function() {
                this.wantsToRegister = !this.wantsToRegister;
            },
            login: function() {
                // TODO validate
                var me = this;
                $.ajax({
                    url: '/api/auth/login',
                    method: 'POST',
                    data: {
                        email: this.email,
                        password: this.password
                    },

                    success: function(data) {
                        console.log(data);
                        if (data.status == 'success') {
                            // go to home
                            me.$emit('login');
                            me.$router.push('/');
                        } else if (data.status == 'failure') {
                            alert(data.msg);
                        } else {
                            console.error('No response');
                        }
                    },

                    error: function() {
                        console.error('error!');
                    }
                });
            },
            register: function() {
                // TODO validate
                var me = this;
                $.ajax({
                    url: '/api/auth/register',
                    method: 'POST',
                    data: {
                        email: this.email,
                        password: this.password,
                        first_name: this.firstName,
                        last_name: this.lastName
                    },

                    success: function(data) {
                        console.log(data);
                        if (data.status == 'success') {
                            // go to home
                            me.$emit('login');
                            me.$router.push('/');
                        } else if (data.status == 'failure') {
                            alert(data.msg);
                        } else {
                            console.error('No response');
                        }
                    },

                    error: function() {
                        console.error('error!');
                    }
                });
            },
        }
    };

    // 2. Define some routes
    // Each route should map to a component. The "component" can
    // either be an actual component constructor created via
    // `Vue.extend()`, or just a component options object.
    // We'll talk about nested routes later.
    const routes = [
        { path: '/login', component: Login },
    ];

    // 3. Create the router instance and pass the `routes` option
    // You can pass in additional options here, but let's
    // keep it simple for now.
    const router = new VueRouter({
        routes // short for `routes: routes`
    })

    // 4. Create and mount the root instance.
    // Make sure to inject the router with the router option to make the
    // whole app router-aware.
    const app = new Vue({
        router,
        data: {
            isAuthenticated: false
        },
        created: function() {
            this.setAuthenticated();
        },
        methods: {
            setAuthenticated: function() {
                this.isAuthenticated = document.cookie.indexOf("authorized=1")!==-1;
                console.log('isAuthenticated?', this.isAuthenticated);
            },
            logout: function() {
                var me = this;
                $.ajax({
                    url: '/api/auth/logout',
                    method: 'POST',

                    success: function(data) {
                        console.log(data);
                        if (data.status == 'success') {
                            // go to home
                            me.setAuthenticated();
                            me.$router.push('/login');
                        } else if (data.status == 'failure') {
                            alert(data.msg);
                        } else {
                            console.error('No response');
                        }
                    },

                    error: function() {
                        console.error('error!');
                    }
                })
            }
        }
    }).$mount('#app')

    // Now the app has started!
</script>
{% endblock %}
